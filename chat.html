<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta charset="UTF-8" />
  <title>Live Terminal Chat</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <!-- Top navigation links -->
  <div class="top-links-wrapper">
    <div class="top-links-inner">
      <a href="#" class="top-link left">[ DEX ]</a>
      <div id="onlineCount" class="top-link center">[ 0 ONLINE ]</div>
      <a href="https://x.com/MonetizedMNDSHR" class="top-link right" target="_blank">[ X ]</a>
    </div>
  </div>
  

  <div id="onlineCount" class="top-link" style="text-align:center; margin-top: 10px;">[ 0 ONLINE ]</div>

  
  <!-- Chat display area -->
  <div class="chat-wrapper">
    <div id="chat"></div>
  </div>

  <!-- Fixed input field styled like "Continue" button -->
  <input id="messageInput" type="text" placeholder="> Hit Enter to send..." autocomplete="off" />

  <!-- Pusher client -->
  <script src="https://js.pusher.com/7.2/pusher.min.js"></script>
  <script>
    const chat = document.getElementById('chat');
    const input = document.getElementById('messageInput');
  
    // Generate or retrieve a random user ID
    let username = localStorage.getItem('chat-username');
    if (!username) {
      username = 'user' + Math.floor(1000 + Math.random() * 9000);
      localStorage.setItem('chat-username', username);
    }
  
    // Connect to Pusher
    Pusher.logToConsole = false;
    const pusher = new Pusher('22541ed2a8183729f691', {
      cluster: 'us2',
      authEndpoint: '/api/pusher-auth',
      auth: {
        params: { username }
      }
    });
  
    // Subscribe to presence channel
    const channel = pusher.subscribe('presence-chat');
  
    // Show online count
    channel.bind('pusher:subscription_succeeded', members => {
  const count = members.count;
  const onlineCountEl = document.getElementById('onlineCount');
  if (onlineCountEl) {
    onlineCountEl.textContent = `[ ${count} ONLINE ]`;
  }
});


  
channel.bind('pusher:member_added', member => {
  const count = channel.members.count;
  document.getElementById('onlineCount').textContent = `[ ${count} ONLINE ]`;
});
  
channel.bind('pusher:member_removed', member => {
  const count = channel.members.count;
  document.getElementById('onlineCount').textContent = `[ ${count} ONLINE ]`;
});
  
    // Sending message
    input.addEventListener('keydown', async function (e) {
      if (e.key === 'Enter' && input.value.trim() !== '') {
        const message = input.value.trim();
        input.value = '';
  
        await fetch('/api/send-message', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message, username })
        });
      }
    });
  
    // Display messages
    const chatBox = document.getElementById('chat');
    channel.bind('chat-event', function(data) {
      const isScrolledToBottom = chatBox.scrollHeight - chatBox.clientHeight <= chatBox.scrollTop + 5;
  
      const msgElement = document.createElement('div');
      msgElement.textContent = `${data.username}: ${data.message}`;
      chatBox.appendChild(msgElement);
  
      if (isScrolledToBottom) {
        chatBox.scrollTop = chatBox.scrollHeight;
      }
    });
  </script>
  

</body>
</html>
